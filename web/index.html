<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RAG Agent API æµ‹è¯•å·¥å…·</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.9;
      }

      .main-content {
        padding: 30px;
      }

      .status-bar {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 2px solid #e9ecef;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #dc3545;
        animation: pulse 2s infinite;
      }

      .status-dot.online {
        background: #28a745;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      .api-section {
        background: #fff;
        border: 2px solid #e9ecef;
        border-radius: 15px;
        margin-bottom: 25px;
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .api-section:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }

      .api-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 20px;
        border-bottom: 1px solid #dee2e6;
        cursor: pointer;
        user-select: none;
      }

      .api-header h3 {
        color: #495057;
        font-size: 1.3em;
        margin-bottom: 5px;
      }

      .api-header .method {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: bold;
        text-transform: uppercase;
        margin-right: 10px;
      }

      .method.get {
        background: #d4edda;
        color: #155724;
      }
      .method.post {
        background: #cce5ff;
        color: #004085;
      }
      .method.delete {
        background: #f8d7da;
        color: #721c24;
      }

      .api-content {
        padding: 25px;
        display: none;
      }

      .api-content.active {
        display: block;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #495057;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .form-group textarea {
        min-height: 100px;
        resize: vertical;
        font-family: "Courier New", monospace;
      }

      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        margin-right: 10px;
        margin-bottom: 10px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      }

      .btn-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      }

      .btn-danger:hover {
        box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
      }

      .response-area {
        margin-top: 25px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        border: 2px solid #e9ecef;
      }

      .response-area h4 {
        margin-bottom: 15px;
        color: #495057;
      }

      .response-content {
        background: #fff;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        font-family: "Courier New", monospace;
        font-size: 13px;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }

      .file-input-wrapper {
        position: relative;
        display: inline-block;
        cursor: pointer;
        width: 100%;
      }

      .file-input {
        opacity: 0;
        position: absolute;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }

      .file-input-display {
        padding: 12px;
        border: 2px dashed #667eea;
        border-radius: 8px;
        text-align: center;
        background: #f8f9ff;
        transition: all 0.3s ease;
      }

      .file-input-display:hover {
        background: #f0f4ff;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .success {
        color: #28a745;
      }
      .error {
        color: #dc3545;
      }
      .info {
        color: #17a2b8;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        border: 2px solid #e9ecef;
        text-align: center;
      }

      .stat-value {
        font-size: 2em;
        font-weight: bold;
        color: #667eea;
      }

      .stat-label {
        color: #6c757d;
        margin-top: 5px;
      }

      .json-viewer {
        background: #2d3748;
        color: #e2e8f0;
        padding: 15px;
        border-radius: 8px;
        font-family: "Courier New", monospace;
        font-size: 13px;
        overflow-x: auto;
      }

      .json-key {
        color: #68d391;
      }
      .json-string {
        color: #f6ad55;
      }
      .json-number {
        color: #4fd1c7;
      }
      .json-boolean {
        color: #f093fb;
      }
      .json-null {
        color: #a0aec0;
      }

      .cleanup-warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        color: #856404;
      }

      .cleanup-warning strong {
        color: #721c24;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ¤– RAG Agent API æµ‹è¯•å·¥å…·</h1>
        <p>æµ‹è¯•å’ŒéªŒè¯ Chalee RAG Agent çš„æ‰€æœ‰APIæ¥å£</p>
      </div>

      <div class="main-content">
        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
          <div class="status-indicator">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">æ£€æŸ¥æœåŠ¡çŠ¶æ€...</span>
          </div>
          <div>
            <input
              type="text"
              id="apiBaseUrl"
              value="http://localhost:3000"
              placeholder="API Base URL"
              style="
                width: 300px;
                padding: 8px;
                border-radius: 5px;
                border: 1px solid #ccc;
              "
            />
            <button class="btn" onclick="checkHealth()">æ£€æŸ¥çŠ¶æ€</button>
          </div>
        </div>

        <!-- 1. å¥åº·æ£€æŸ¥ -->
        <div class="api-section">
          <div class="api-header" onclick="toggleSection('health')">
            <h3>
              <span class="method get">GET</span>
              å¥åº·æ£€æŸ¥ - /health
            </h3>
            <p>æ£€æŸ¥æœåŠ¡å™¨è¿è¡ŒçŠ¶æ€</p>
          </div>
          <div class="api-content" id="health-content">
            <button class="btn" onclick="testHealth()">
              <span
                id="health-loading"
                style="display: none"
                class="loading"
              ></span>
              æµ‹è¯•å¥åº·æ£€æŸ¥
            </button>
            <div
              class="response-area"
              id="health-response"
              style="display: none"
            >
              <h4>å“åº”ç»“æœ:</h4>
              <div class="response-content" id="health-result"></div>
            </div>
          </div>
        </div>

        <!-- 2. æŸ¥è¯¢æ¥å£ -->
        <div class="api-section">
          <div class="api-header" onclick="toggleSection('query')">
            <h3>
              <span class="method post">POST</span>
              æ™ºèƒ½é—®ç­” - /query
            </h3>
            <p>å‘RAG Agentæé—®å¹¶è·å–AIå›ç­”</p>
          </div>
          <div class="api-content" id="query-content">
            <div class="form-group">
              <label for="queryQuestion">é—®é¢˜:</label>
              <textarea
                id="queryQuestion"
                placeholder="è¾“å…¥ä½ çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿ"
              >
ä»€ä¹ˆæ˜¯RAGæŠ€æœ¯ï¼Ÿ</textarea
              >
            </div>
            <button class="btn" onclick="testQuery()">
              <span
                id="query-loading"
                style="display: none"
                class="loading"
              ></span>
              å‘é€æŸ¥è¯¢
            </button>
            <div
              class="response-area"
              id="query-response"
              style="display: none"
            >
              <h4>AIå›ç­”:</h4>
              <div class="response-content" id="query-result"></div>
            </div>
          </div>
        </div>

        <!-- 3. æ–‡æ¡£ä¸Šä¼  -->
        <div class="api-section">
          <div class="api-header" onclick="toggleSection('upload')">
            <h3>
              <span class="method post">POST</span>
              æ–‡æ¡£ä¸Šä¼  - /upload
            </h3>
            <p>ä¸Šä¼ æ–‡æœ¬æ–‡ä»¶åˆ°çŸ¥è¯†åº“</p>
          </div>
          <div class="api-content" id="upload-content">
            <div class="form-group">
              <label>é€‰æ‹©æ–‡ä»¶:</label>
              <div class="file-input-wrapper">
                <input
                  type="file"
                  class="file-input"
                  id="uploadFiles"
                  multiple
                  accept=".txt,.md"
                />
                <div class="file-input-display">
                  ç‚¹å‡»é€‰æ‹©æ–‡æœ¬æ–‡ä»¶ (.txt, .md)
                </div>
              </div>
              <div id="fileList" style="margin-top: 10px"></div>
            </div>
            <button class="btn" onclick="testUpload()">
              <span
                id="upload-loading"
                style="display: none"
                class="loading"
              ></span>
              ä¸Šä¼ æ–‡ä»¶
            </button>
            <div
              class="response-area"
              id="upload-response"
              style="display: none"
            >
              <h4>ä¸Šä¼ ç»“æœ:</h4>
              <div class="response-content" id="upload-result"></div>
            </div>
          </div>
        </div>

        <!-- 4. æ‰¹é‡æ·»åŠ æ–‡æ¡£ -->
        <div class="api-section">
          <div class="api-header" onclick="toggleSection('batch')">
            <h3>
              <span class="method post">POST</span>
              æ‰¹é‡æ·»åŠ  - /documents/batch
            </h3>
            <p>æ‰¹é‡æ·»åŠ æ–‡æ¡£åˆ°çŸ¥è¯†åº“</p>
          </div>
          <div class="api-content" id="batch-content">
            <div class="form-group">
              <label for="batchDocuments">æ–‡æ¡£æ•°æ® (JSONæ ¼å¼):</label>
              <textarea id="batchDocuments" style="height: 150px">
[
  {
    "content": "äººå·¥æ™ºèƒ½ï¼ˆAIï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œæ—¨åœ¨åˆ›é€ èƒ½å¤Ÿæ‰§è¡Œé€šå¸¸éœ€è¦äººç±»æ™ºèƒ½çš„ä»»åŠ¡çš„æœºå™¨ã€‚",
    "source": "ai_definition.txt"
  },
  {
    "content": "æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªé‡è¦å­é¢†åŸŸï¼Œå®ƒä½¿è®¡ç®—æœºèƒ½å¤Ÿåœ¨æ²¡æœ‰æ˜ç¡®ç¼–ç¨‹çš„æƒ…å†µä¸‹å­¦ä¹ å’Œæ”¹è¿›ã€‚",
    "source": "machine_learning.txt"
  }
]</textarea
              >
            </div>
            <button class="btn" onclick="testBatch()">
              <span
                id="batch-loading"
                style="display: none"
                class="loading"
              ></span>
              æ‰¹é‡æ·»åŠ 
            </button>
            <button class="btn btn-secondary" onclick="addSampleData()">
              æ·»åŠ ç¤ºä¾‹æ•°æ®
            </button>
            <div
              class="response-area"
              id="batch-response"
              style="display: none"
            >
              <h4>æ·»åŠ ç»“æœ:</h4>
              <div class="response-content" id="batch-result"></div>
            </div>
          </div>
        </div>

        <!-- 5. æ–‡æ¡£æ£€ç´¢ -->
        <div class="api-section">
          <div class="api-header" onclick="toggleSection('retrieve')">
            <h3>
              <span class="method post">POST</span>
              æ–‡æ¡£æ£€ç´¢ - /retrieve
            </h3>
            <p>æ£€ç´¢ç›¸å…³æ–‡æ¡£ç‰‡æ®µ</p>
          </div>
          <div class="api-content" id="retrieve-content">
            <div class="form-group">
              <label for="retrieveQuery">æ£€ç´¢æŸ¥è¯¢:</label>
              <input
                type="text"
                id="retrieveQuery"
                placeholder="è¾“å…¥æ£€ç´¢å…³é”®è¯"
                value="äººå·¥æ™ºèƒ½"
              />
            </div>
            <div class="form-group">
              <label for="retrieveTopK">è¿”å›æ•°é‡:</label>
              <select id="retrieveTopK">
                <option value="3">3ä¸ªç»“æœ</option>
                <option value="5" selected>5ä¸ªç»“æœ</option>
                <option value="10">10ä¸ªç»“æœ</option>
              </select>
            </div>
            <button class="btn" onclick="testRetrieve()">
              <span
                id="retrieve-loading"
                style="display: none"
                class="loading"
              ></span>
              å¼€å§‹æ£€ç´¢
            </button>
            <div
              class="response-area"
              id="retrieve-response"
              style="display: none"
            >
              <h4>æ£€ç´¢ç»“æœ:</h4>
              <div class="response-content" id="retrieve-result"></div>
            </div>
          </div>
        </div>

        <!-- 6. ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="api-section">
          <div class="api-header" onclick="toggleSection('stats')">
            <h3>
              <span class="method get">GET</span>
              ç»Ÿè®¡ä¿¡æ¯ - /stats
            </h3>
            <p>è·å–çŸ¥è¯†åº“ç»Ÿè®¡ä¿¡æ¯</p>
          </div>
          <div class="api-content" id="stats-content">
            <button class="btn" onclick="testStats()">
              <span
                id="stats-loading"
                style="display: none"
                class="loading"
              ></span>
              è·å–ç»Ÿè®¡
            </button>
            <div
              class="response-area"
              id="stats-response"
              style="display: none"
            >
              <h4>ç»Ÿè®¡ä¿¡æ¯:</h4>
              <div class="stats-grid" id="stats-grid"></div>
              <div class="response-content" id="stats-result"></div>
            </div>
          </div>
        </div>

        <!-- 7. æ¸…ç†çŸ¥è¯†åº“ -->
        <div class="api-section">
          <div class="api-header" onclick="toggleSection('cleanup')">
            <h3>
              <span class="method delete">DELETE</span>
              æ¸…ç†çŸ¥è¯†åº“ - /cleanup
            </h3>
            <p>æ¸…ç©ºæ‰€æœ‰æ–‡æ¡£å’Œå‘é‡æ•°æ®</p>
          </div>
          <div class="api-content" id="cleanup-content">
            <div class="cleanup-warning">
              <strong>âš ï¸ å±é™©æ“ä½œè­¦å‘Š</strong><br />
              æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤çŸ¥è¯†åº“ä¸­çš„æ‰€æœ‰æ–‡æ¡£å’Œå‘é‡æ•°æ®ï¼Œå¹¶ä¸”æ— æ³•æ’¤é”€ã€‚è¯·ç¡®è®¤æ‚¨çœŸçš„è¦æ¸…ç©ºæ•´ä¸ªçŸ¥è¯†åº“ã€‚
            </div>

            <div class="form-group">
              <label for="cleanupConfirm"
                >ç¡®è®¤æ“ä½œ (è¯·è¾“å…¥ "CONFIRM" ä»¥ç»§ç»­):</label
              >
              <input
                type="text"
                id="cleanupConfirm"
                placeholder="è¾“å…¥ CONFIRM"
                maxlength="7"
              />
            </div>

            <button class="btn btn-danger" onclick="testCleanup()">
              <span
                id="cleanup-loading"
                style="display: none"
                class="loading"
              ></span>
              ğŸ—‘ï¸ æ¸…ç©ºçŸ¥è¯†åº“
            </button>

            <div
              class="response-area"
              id="cleanup-response"
              style="display: none"
            >
              <h4>æ¸…ç†ç»“æœ:</h4>
              <div class="response-content" id="cleanup-result"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // è·å–APIåŸºç¡€URL
      function getApiBaseUrl() {
        return document.getElementById("apiBaseUrl").value.trim();
      }

      // æ˜¾ç¤º/éšè—APIéƒ¨åˆ†
      function toggleSection(sectionId) {
        const content = document.getElementById(sectionId + "-content");
        content.classList.toggle("active");
      }

      // é»˜è®¤å±•å¼€ç¬¬ä¸€ä¸ªéƒ¨åˆ†
      document.getElementById("health-content").classList.add("active");

      // æ˜¾ç¤ºå“åº”ç»“æœ
      function showResponse(sectionId, data, isError = false) {
        const responseArea = document.getElementById(sectionId + "-response");
        const resultDiv = document.getElementById(sectionId + "-result");

        responseArea.style.display = "block";

        if (typeof data === "object") {
          resultDiv.innerHTML = formatJson(data);
        } else {
          resultDiv.textContent = data;
        }

        resultDiv.className =
          "response-content " + (isError ? "error" : "success");
      }

      // æ ¼å¼åŒ–JSONæ˜¾ç¤º
      function formatJson(obj) {
        return (
          '<div class="json-viewer">' +
          syntaxHighlight(JSON.stringify(obj, null, 2)) +
          "</div>"
        );
      }

      // JSONè¯­æ³•é«˜äº®
      function syntaxHighlight(json) {
        json = json
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
        return json.replace(
          /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
          function (match) {
            var cls = "json-number";
            if (/^"/.test(match)) {
              if (/:$/.test(match)) {
                cls = "json-key";
              } else {
                cls = "json-string";
              }
            } else if (/true|false/.test(match)) {
              cls = "json-boolean";
            } else if (/null/.test(match)) {
              cls = "json-null";
            }
            return '<span class="' + cls + '">' + match + "</span>";
          }
        );
      }

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      function showLoading(sectionId, show = true) {
        const loadingEl = document.getElementById(sectionId + "-loading");
        if (loadingEl) {
          loadingEl.style.display = show ? "inline-block" : "none";
        }
      }

      // é€šç”¨APIè¯·æ±‚å‡½æ•°
      async function apiRequest(
        method,
        endpoint,
        data = null,
        isFormData = false
      ) {
        const url = getApiBaseUrl() + endpoint;
        const options = {
          method: method,
          headers: {},
        };

        if (data && !isFormData) {
          options.headers["Content-Type"] = "application/json";
          options.body = JSON.stringify(data);
        } else if (data && isFormData) {
          options.body = data;
        }

        try {
          const response = await fetch(url, options);
          const result = await response.json();

          if (!response.ok) {
            throw new Error(
              `HTTP ${response.status}: ${result.error || "è¯·æ±‚å¤±è´¥"}`
            );
          }

          return result;
        } catch (error) {
          console.error("APIè¯·æ±‚é”™è¯¯:", error);
          throw error;
        }
      }

      // 1. å¥åº·æ£€æŸ¥
      async function checkHealth() {
        await testHealth();
      }

      async function testHealth() {
        showLoading("health");
        try {
          const result = await apiRequest("GET", "/health");
          showResponse("health", result);

          // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
          const statusDot = document.getElementById("statusDot");
          const statusText = document.getElementById("statusText");
          statusDot.classList.add("online");
          statusText.textContent = "æœåŠ¡æ­£å¸¸è¿è¡Œ";
          statusText.className = "success";
        } catch (error) {
          showResponse("health", { error: error.message }, true);

          // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
          const statusDot = document.getElementById("statusDot");
          const statusText = document.getElementById("statusText");
          statusDot.classList.remove("online");
          statusText.textContent = "æœåŠ¡è¿æ¥å¤±è´¥";
          statusText.className = "error";
        } finally {
          showLoading("health", false);
        }
      }

      // 2. æŸ¥è¯¢æ¥å£
      async function testQuery() {
        const question = document.getElementById("queryQuestion").value.trim();
        if (!question) {
          alert("è¯·è¾“å…¥é—®é¢˜");
          return;
        }

        showLoading("query");
        try {
          const result = await apiRequest("POST", "/query", { question });
          showResponse("query", result);
        } catch (error) {
          showResponse("query", { error: error.message }, true);
        } finally {
          showLoading("query", false);
        }
      }

      // 3. æ–‡ä»¶ä¸Šä¼ 
      function updateFileList() {
        const files = document.getElementById("uploadFiles").files;
        const fileList = document.getElementById("fileList");

        if (files.length > 0) {
          let html = "<h5>å·²é€‰æ‹©çš„æ–‡ä»¶:</h5><ul>";
          for (let i = 0; i < files.length; i++) {
            html += `<li>${files[i].name} (${(files[i].size / 1024).toFixed(
              1
            )} KB)</li>`;
          }
          html += "</ul>";
          fileList.innerHTML = html;
        } else {
          fileList.innerHTML = "";
        }
      }

      document
        .getElementById("uploadFiles")
        .addEventListener("change", updateFileList);

      async function testUpload() {
        const files = document.getElementById("uploadFiles").files;
        if (files.length === 0) {
          alert("è¯·é€‰æ‹©æ–‡ä»¶");
          return;
        }

        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
          formData.append("documents", files[i]);
        }

        showLoading("upload");
        try {
          const result = await apiRequest("POST", "/upload", formData, true);
          showResponse("upload", result);
        } catch (error) {
          showResponse("upload", { error: error.message }, true);
        } finally {
          showLoading("upload", false);
        }
      }

      // 4. æ‰¹é‡æ·»åŠ æ–‡æ¡£
      async function testBatch() {
        const documentsText = document
          .getElementById("batchDocuments")
          .value.trim();
        if (!documentsText) {
          alert("è¯·è¾“å…¥æ–‡æ¡£æ•°æ®");
          return;
        }

        try {
          const documents = JSON.parse(documentsText);

          showLoading("batch");
          const result = await apiRequest("POST", "/documents/batch", {
            documents,
          });
          showResponse("batch", result);
        } catch (error) {
          if (error instanceof SyntaxError) {
            showResponse(
              "batch",
              { error: "JSONæ ¼å¼é”™è¯¯: " + error.message },
              true
            );
          } else {
            showResponse("batch", { error: error.message }, true);
          }
        } finally {
          showLoading("batch", false);
        }
      }

      // æ·»åŠ ç¤ºä¾‹æ•°æ®
      function addSampleData() {
        const sampleData = [
          {
            content:
              "Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 å¼•æ“çš„ JavaScript è¿è¡Œæ—¶ç¯å¢ƒã€‚å®ƒå…è®¸å¼€å‘è€…åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScript ä»£ç ï¼Œå…·æœ‰äº‹ä»¶é©±åŠ¨ã€éé˜»å¡ I/O æ¨¡å‹ç­‰ç‰¹ç‚¹ã€‚",
            source: "nodejs_intro.txt",
          },
          {
            content:
              "Express.js æ˜¯ Node.js æœ€æµè¡Œçš„ Web åº”ç”¨æ¡†æ¶ä¹‹ä¸€ã€‚å®ƒæä¾›äº†ä¸€å¥—å¼ºå¤§çš„åŠŸèƒ½æ¥å¼€å‘ Web å’Œç§»åŠ¨åº”ç”¨ç¨‹åºï¼Œç®€åŒ–äº†æœåŠ¡å™¨åˆ›å»ºè¿‡ç¨‹ã€‚",
            source: "express_intro.txt",
          },
          {
            content:
              "RESTful API æ˜¯ä¸€ç§åŸºäº REST æ¶æ„é£æ ¼çš„åº”ç”¨ç¨‹åºæ¥å£ã€‚å®ƒä½¿ç”¨æ ‡å‡†çš„ HTTP æ–¹æ³•æ¥æ“ä½œèµ„æºï¼Œå…·æœ‰æ— çŠ¶æ€ã€å¯ç¼“å­˜ã€ç»Ÿä¸€æ¥å£ç­‰ç‰¹ç‚¹ã€‚",
            source: "restful_api.txt",
          },
        ];

        document.getElementById("batchDocuments").value = JSON.stringify(
          sampleData,
          null,
          2
        );
      }

      // 5. æ–‡æ¡£æ£€ç´¢
      async function testRetrieve() {
        const query = document.getElementById("retrieveQuery").value.trim();
        const topK = parseInt(document.getElementById("retrieveTopK").value);

        if (!query) {
          alert("è¯·è¾“å…¥æ£€ç´¢æŸ¥è¯¢");
          return;
        }

        showLoading("retrieve");
        try {
          const result = await apiRequest("POST", "/retrieve", { query, topK });
          showResponse("retrieve", result);
        } catch (error) {
          showResponse("retrieve", { error: error.message }, true);
        } finally {
          showLoading("retrieve", false);
        }
      }

      // 6. ç»Ÿè®¡ä¿¡æ¯
      async function testStats() {
        showLoading("stats");
        try {
          const result = await apiRequest("GET", "/stats");
          showResponse("stats", result);

          // æ˜¾ç¤ºç»Ÿè®¡å¡ç‰‡
          const statsGrid = document.getElementById("stats-grid");
          statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${
                          result.documentCount || 0
                        }</div>
                        <div class="stat-label">æ–‡æ¡£æ•°é‡</div>
                    </div>
                `;
        } catch (error) {
          showResponse("stats", { error: error.message }, true);
        } finally {
          showLoading("stats", false);
        }
      }

      // 7. æ¸…ç†çŸ¥è¯†åº“
      async function testCleanup() {
        const confirmInput = document
          .getElementById("cleanupConfirm")
          .value.trim();
        if (confirmInput !== "CONFIRM") {
          alert("è¯·ç¡®è®¤è¾“å…¥ 'CONFIRM' ä»¥ç»§ç»­");
          return;
        }

        showLoading("cleanup");
        try {
          const result = await apiRequest("POST", "/cleanup");
          showResponse("cleanup", result);
        } catch (error) {
          showResponse("cleanup", { error: error.message }, true);
        } finally {
          showLoading("cleanup", false);
        }
      }
      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥å¥åº·çŠ¶æ€
      window.addEventListener("load", function () {
        setTimeout(checkHealth, 1000);
      });

      // è‡ªåŠ¨åˆ·æ–°çŠ¶æ€
      setInterval(checkHealth, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
    </script>
  </body>
</html>
